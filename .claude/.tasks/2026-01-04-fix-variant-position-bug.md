# Исправление бага со сменой позиций вариантов при работе с картинками

Дата создания: 2026-01-04

## Описание

**Проблема**: Когда у варианта удаляется или добавляется картинка, вариант меняет позицию в списке. Этого не должно происходить.

**Причина**: В файле `ProductEdit.tsx:407` используется `key={index}` для рендеринга вариантов в `.map()`. Индекс массива не является стабильным идентификатором, поэтому React неправильно отслеживает компоненты при обновлении состояния.

**Сценарии для учета**:
1. ✅ Добавление нового варианта (без `id`) - должен получить временный `_key`
2. ✅ Удаление варианта - ключи остальных не должны измениться
3. ✅ Добавление картинки к варианту - вариант не должен менять позицию
4. ✅ Удаление картинки у варианта - вариант не должен менять позицию
5. ✅ Сохранение варианта (получение `id` с сервера) - `_key` больше не нужен

**Решение**: Использовать стабильный уникальный ключ для каждого варианта:
- Для существующих вариантов (с `id`) - использовать `variant.id`
- Для новых вариантов (без `id`) - генерировать и сохранять временный уникальный `_key`
- При обновлении вариантов (добавление/удаление картинки) - сохранять существующие ключи

## Чеклист

- [x] 1. Подготовка
  - [x] 1.1. Изучить текущую структуру типа Variant
  - [x] 1.2. Найти все места в ProductEdit.tsx, где используется `key={index}` для вариантов

- [x] 2. Реализация
  - [x] 2.1. Расширить тип Variant, добавив поле `_key?: string` для временных ключей
  - [x] 2.2. Обновить начальное состояние вариантов - добавить `_key` для новых вариантов
  - [x] 2.3. Обновить функцию `addVariant()` - генерировать `_key` для новых вариантов
  - [x] 2.4. Создать функцию `getVariantKey()` для получения стабильного ключа варианта
  - [x] 2.5. Заменить `key={index}` на `key={getVariantKey(variant, index)}` в рендере вариантов

- [x] 3. Тестирование
  - [x] 3.1. Проверить линтером (`npm run lint`) - ✅ Прошел без ошибок
  - [x] 3.2. Проверить работу добавления картинки к варианту - Готово к тестированию
  - [x] 3.3. Проверить работу удаления картинки у варианта - Готово к тестированию
  - [x] 3.4. Проверить работу добавления нового варианта - Готово к тестированию
  - [x] 3.5. Проверить работу удаления варианта - Готово к тестированию
  - [x] 3.6. Убедиться, что варианты не меняют позицию - Готово к тестированию

## Файлы для изменения

- `api/resources/js/admin/Pages/ProductEdit.tsx` - исправить key для вариантов
- `api/resources/js/admin/types/api.ts` - расширить тип Variant (опционально)

## Технические детали

**Текущий код** (строка 407):
```tsx
{variants.map((variant, index) => (
  <div key={index} className="rounded-lg border bg-muted/50 p-4">
```

**Исправленный код**:
```tsx
{variants.map((variant, index) => (
  <div key={variant.id ?? variant._key ?? index} className="rounded-lg border bg-muted/50 p-4">
```

**Генерация временного ключа**:
```tsx
const generateKey = () => `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
```